# -*- coding: utf-8 -*-
"""App.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15xSzM5rKsNfw8oqk_JqC9NzmD89_74p_
"""

import streamlit as st
from datetime import date, timedelta
import sqlite3
import pandas as pd
import pyttsx3
from sentence_transformers import SentenceTransformer, util

# =========================
# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©
# =========================
st.set_page_config(
    page_title="Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# =========================
# Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© + seed
# =========================
@st.cache_resource
def init_db():
    conn = sqlite3.connect(":memory:", check_same_thread=False)
    cur = conn.cursor()
    cur.executescript("""
    CREATE TABLE Students (
        StudentID INTEGER PRIMARY KEY AUTOINCREMENT,
        Username TEXT UNIQUE,
        Password TEXT,
        FullName TEXT,
        Department TEXT
    );
    CREATE TABLE Schedules (
        ScheduleID INTEGER PRIMARY KEY AUTOINCREMENT,
        StudentID INTEGER,
        Day TEXT,
        StartTime TEXT,
        EndTime TEXT,
        Subject TEXT,
        Room TEXT
    );
    CREATE TABLE Tasks (
        TaskID INTEGER PRIMARY KEY AUTOINCREMENT,
        StudentID INTEGER,
        Title TEXT,
        DueDate TEXT,
        EstHours REAL,
        Priority TEXT,
        Done INTEGER DEFAULT 0
    );
    CREATE TABLE Embeddings (
        TaskID INTEGER PRIMARY KEY,
        Embedding BLOB
    );
    """)
    return conn, cur

@st.cache_data
def seed_demo(cur):
    cur.execute("INSERT INTO Students (Username, Password, FullName, Department) VALUES (?,?,?,?)",
                ("ahmed","1234","Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯","Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³ÙˆØ¨"))
    today = date.today()
    cur.executemany("INSERT INTO Schedules (StudentID, Day, StartTime, EndTime, Subject, Room) VALUES (?,?,?,?,?,?)", [
        (1,"Ø§Ù„Ø£Ø­Ø¯","09:00","11:00","Ø¨Ø±Ù…Ø¬Ø©","A101"),
        (1,"Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","10:00","12:00","Ø±ÙŠØ§Ø¶ÙŠØ§Øª","B201"),
        (1,"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","11:00","13:00","Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ","A102"),
        (1,"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","09:00","11:00","ÙÙŠØ²ÙŠØ§Ø¡","C101"),
        (1,"Ø§Ù„Ø®Ù…ÙŠØ³","10:00","12:00","Ù†Ø¸Ù… ØªØ´ØºÙŠÙ„","C301")
    ])
    cur.executemany("INSERT INTO Tasks (StudentID, Title, DueDate, EstHours, Priority) VALUES (?,?,?,?,?)", [
        (1,"Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§ÙŠØ«ÙˆÙ†","%s"%(today + timedelta(days=3)),6.0,"High"),
        (1,"ÙˆØ§Ø¬Ø¨ Ø±ÙŠØ§Ø¶ÙŠØ§Øª","%s"%(today + timedelta(days=1)),2.0,"Medium"),
        (1,"Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ","%s"%(today + timedelta(days=7)),4.0,"Low"),
        (1,"ØªØ¬Ù‡ÙŠØ² Ù…Ø®ØªØ¨Ø± Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡","%s"%(today + timedelta(days=2)),3.0,"High")
    ])

# =========================
# Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
# =========================
def authenticate(cur, username, password):
    cur.execute("SELECT StudentID, FullName, Department FROM Students WHERE Username=? AND Password=?", (username, password))
    return cur.fetchone()

def fetch_schedule(cur, student_id):
    cur.execute("SELECT Day, StartTime, EndTime, Subject, Room FROM Schedules WHERE StudentID=? ORDER BY Day, StartTime", (student_id,))
    return cur.fetchall()

def fetch_tasks(cur, student_id):
    cur.execute("SELECT TaskID, Title, DueDate, EstHours, Priority, Done FROM Tasks WHERE StudentID=? ORDER BY DueDate", (student_id,))
    return cur.fetchall()

def update_task_done(cur, task_id):
    cur.execute("UPDATE Tasks SET Done=1 WHERE TaskID=?", (task_id,))

def get_upcoming_tasks(tasks, days=3):
    now = date.today()
    return [t for t in tasks if not t[5] and now <= date.fromisoformat(t[2]) <= now+timedelta(days=days)]

def get_overdue_tasks(tasks):
    now = date.today()
    return [t for t in tasks if not t[5] and date.fromisoformat(t[2]) < now]

def summarize_week(tasks):
    today = date.today()
    week_end = today + timedelta(days=7)
    week_tasks = [t for t in tasks if today <= date.fromisoformat(t[2]) <= week_end and not t[5]]
    return week_tasks

def plan_study(tasks):
    plan = sorted([t for t in tasks if not t[5]], key=lambda x: (x[4], x[2]))
    return plan

# =========================
# Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ù…ÙˆØ°Ø¬ Embeddings Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ
# =========================
@st.cache_resource
def init_embeddings():
    model = SentenceTransformer('all-MiniLM-L6-v2')
    return model

def semantic_search(query, tasks, model):
    if not tasks:
        return []
    task_texts = [t[1] for t in tasks]
    embeddings = model.encode(task_texts, convert_to_tensor=True)
    query_emb = model.encode(query, convert_to_tensor=True)
    hits = util.semantic_search(query_emb, embeddings, top_k=3)
    results = [tasks[h['corpus_id']] for h in hits[0]]
    return results

# =========================
# Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØªÙŠ
# =========================
def speak(text):
    engine = pyttsx3.init()
    engine.say(text)
    engine.runAndWait()

# =========================
# Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# =========================
def main():
    st.title("ğŸ“˜ Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø°ÙƒÙŠ")

    if "db_init" not in st.session_state:
        conn, cur = init_db()
        seed_demo(cur)
        conn.commit()
        st.session_state.conn = conn
        st.session_state.cur = cur
        st.session_state.db_init = True

    cur = st.session_state.cur

    # ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
    if "student" not in st.session_state:
        with st.form("login_form"):
            username = st.text_input("ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
            password = st.text_input("ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
            submit = st.form_submit_button("Ø¯Ø®ÙˆÙ„")
            if submit:
                auth = authenticate(cur, username, password)
                if auth:
                    st.session_state.student = {"id": auth[0], "name": auth[1], "dept": auth[2]}
                    st.success(f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {auth[1]} ğŸ‘‹")
                else:
                    st.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
        return

    student_id = st.session_state.student["id"]

    st.subheader(f"Ù…Ø±Ø­Ø¨Ø§ {st.session_state.student['name']} â€” {st.session_state.student['dept']}")

    # Ø¬Ø¯ÙˆÙ„ Ùˆ Ù…Ù‡Ø§Ù…
    schedule = fetch_schedule(cur, student_id)
    tasks = fetch_tasks(cur, student_id)

    st.write("### ğŸ—“ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹")
    st.table(pd.DataFrame(schedule, columns=["Ø§Ù„ÙŠÙˆÙ…","Ø§Ù„Ø³Ø§Ø¹Ø© Ù…Ù†","Ø§Ù„Ø³Ø§Ø¹Ø© Ø¥Ù„Ù‰","Ø§Ù„Ù…Ø§Ø¯Ø©","Ø§Ù„ØºØ±ÙØ©"]))

    st.write("### âœ… Ø§Ù„Ù…Ù‡Ø§Ù…")
    st.table(pd.DataFrame(tasks, columns=["ID","Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©","Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©","ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²"]))

    # ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
    st.write("### ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©")
    for t in tasks:
        if not t[5]:
            if st.button(f"ØªÙ… Ø¥Ù†Ø¬Ø§Ø²: {t[1]}", key=t[0]):
                update_task_done(cur, t[0])
                st.success(f"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©: {t[1]}")

    # Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠ
    st.write("### ğŸ” Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ Ø¹Ù† Ø§Ù„Ù…Ù‡Ø§Ù…")
    model = init_embeddings()
    query = st.text_input("Ø§ÙƒØªØ¨ Ù†Øµ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‡Ù…Ø©")
    if query:
        results = semantic_search(query, tasks, model)
        for r in results:
            st.info(f"{r[1]} â€” ØªØ³Ù„ÙŠÙ…: {r[2]}")

    # Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØªÙŠ
    st.write("### ğŸ¤ Ù…Ø³Ø§Ø¹Ø¯ ØµÙˆØªÙŠ")
    text_to_speak = st.text_input("Ø§ÙƒØªØ¨ Ù†Øµ Ù„ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù„ØµÙˆØª")
    if st.button("ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª"):
        speak(text_to_speak)

    # Google Calendar Ø±Ø§Ø¨Ø·
    st.write("### ğŸ“… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ù… Ø¥Ù„Ù‰ Google Calendar")
    for t in tasks:
        if not t[5]:
            gcal_link = f"https://calendar.google.com/calendar/render?action=TEMPLATE&text={t[1]}&dates={t[2].replace('-','')}T090000Z/{t[2].replace('-','')}T100000Z"
            st.markdown(f"[â• Ø¥Ø¶Ø§ÙØ© {t[1]}]( {gcal_link} )", unsafe_allow_html=True)

if __name__ == "__main__":
    main()